document.addEventListener('DOMContentLoaded',async()=>{const e=await chrome.storage.local.get(["jiraUrl"]);e.jiraUrl&&(document.getElementById("jiraUrl").value=e.jiraUrl)});document.getElementById("saveConfig").addEventListener("click",async()=>{const e=document.getElementById("jiraUrl").value.trim();e?(await chrome.storage.local.set({jiraUrl:e}),showStatus("Configuration saved!","success")):showStatus("Please enter a Jira URL","error")});document.getElementById("findStaleTickets").addEventListener("click",async()=>{const e=await chrome.storage.local.get(["jiraUrl"]);e.jiraUrl?await runQuery("updated < -7d AND status != Closed AND status != Done ORDER BY updated ASC",e.jiraUrl):showStatus("Please configure Jira URL first","error")});document.getElementById("findMissingFields").addEventListener("click",async()=>{const e=await chrome.storage.local.get(["jiraUrl"]);e.jiraUrl?await runQuery("description is EMPTY AND status != Closed AND status != Done ORDER BY created DESC",e.jiraUrl):showStatus("Please configure Jira URL first","error")});document.getElementById("findNoDueDate").addEventListener("click",async()=>{const e=await chrome.storage.local.get(["jiraUrl"]);e.jiraUrl?await runQuery("duedate is EMPTY AND status != Closed AND status != Done ORDER BY created DESC",e.jiraUrl):showStatus("Please configure Jira URL first","error")});document.getElementById("runCustomQuery").addEventListener("click",async()=>{const e=await chrome.storage.local.get(["jiraUrl"]);if(!e.jiraUrl)return void showStatus("Please configure Jira URL first","error");const t=document.getElementById("customJql").value.trim();t?await runQuery(t,e.jiraUrl):showStatus("Please enter a JQL query","error")});document.getElementById("addComment").addEventListener("click",async()=>{const e=prompt("Enter comment to add to all tickets:");if(e){const t=await chrome.storage.local.get(["lastResults"]);if(!t.lastResults||0===t.lastResults.length)return void showStatus("No tickets found. Run a query first.","error");showStatus(`Adding comment to ${t.lastResults.length} tickets...`,"info");const[a]=await chrome.tabs.query({active:!0,currentWindow:!0}),s=await chrome.tabs.sendMessage(a.id,{action:"addComments",tickets:t.lastResults,comment:e});s.error?showStatus(`Error: ${s.error}`,"error"):showStatus(s.message,"success")}});async function runQuery(e,t){showStatus("Running query...","info");try{const[a]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!a.url.includes(new URL(t).hostname))return void showStatus("Please open a Jira page first, then try again","error");const s=await chrome.tabs.sendMessage(a.id,{action:"runJql",jql:e});if(s.error)return void showStatus(`Error: ${s.error}`,"error");await chrome.storage.local.set({lastResults:s.tickets});const r=s.tickets.length;showStatus(`Found ${r} ticket(s). Opening in new tab...`,"success");const i=`${t}/issues/?jql=${encodeURIComponent(e)}`;chrome.tabs.create({url:i})}catch(e){showStatus(`Error: ${e.message}. Make sure you're on a Jira page.`,"error")}}function showStatus(e,t){const a=document.getElementById("status");a.textContent=e,a.className=`status-${t}`,a.style.display="block","success"===t&&setTimeout(()=>{a.style.display="none"},3e3)}