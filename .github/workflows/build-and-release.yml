name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version_type:
        description: 'Version bump type'
        required: true
        default: 'minor'
        type: choice
        options:
          - major
          - minor
          - patch
      pre_release:
        description: 'Mark as pre-release'
        required: false
        default: false
        type: boolean

jobs:
  build-and-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Get latest tag
        id: get_tag
        run: |
          $latestTag = git describe --tags --abbrev=0 2>$null
          if (-not $latestTag) { $latestTag = "v0.0.0" }
          echo "latest_tag=$latestTag" >> $env:GITHUB_OUTPUT
          echo "Latest tag: $latestTag"
        shell: pwsh
      
      - name: Calculate new version
        id: calc_version
        run: |
          $latestTag = "${{ steps.get_tag.outputs.latest_tag }}"
          $version = $latestTag -replace '^v', ''
          $parts = $version -split '\.'
          $major = [int]$parts[0]
          $minor = [int]$parts[1]
          $patch = [int]$parts[2]
          
          switch ("${{ github.event.inputs.version_type }}") {
            "major" {
              $major++
              $minor = 0
              $patch = 0
            }
            "minor" {
              $minor++
              $patch = 0
            }
            "patch" {
              $patch++
            }
          }
          
          $newVersion = "v$major.$minor.$patch"
          echo "new_version=$newVersion" >> $env:GITHUB_OUTPUT
          echo "New version: $newVersion"
        shell: pwsh
      
      - name: Build executable with PyInstaller
        run: |
          if (Test-Path "GitHubJiraSync.spec") {
            pyinstaller GitHubJiraSync.spec
          } elseif (Test-Path "JiraAutomationAssistant.spec") {
            pyinstaller JiraAutomationAssistant.spec
          } else {
            pyinstaller --name="GitHubJiraSync" --onefile --windowed --icon="assets/icon.ico" app.py
          }
        shell: pwsh
      
      - name: Prepare release assets
        run: |
          $version = "${{ steps.calc_version.outputs.new_version }}"
          New-Item -ItemType Directory -Force -Path release
          
          # Find the built executable
          $exePath = Get-ChildItem -Path "dist" -Filter "*.exe" -Recurse | Select-Object -First 1
          
          if ($exePath) {
            $exeName = $exePath.Name
            Copy-Item $exePath.FullName -Destination "release/GitHubJiraSync-$version.exe"
            
            # Create release notes
            $releaseNotes = @"
          # Release $version
          
          ## What's New
          
          See [IMPLEMENTATION_COMPLETE.md](IMPLEMENTATION_COMPLETE.md) for full details.
          
          ## Installation
          
          1. Download ``GitHubJiraSync-$version.exe``
          2. Run the executable
          3. Browser will open to http://localhost:5000
          4. Configure your settings and start using the app
          
          ## Requirements
          
          - Windows 10/11
          - Chrome browser (for Jira automation)
          
          ## Changes in this release
          
          See the [commit history](https://github.com/${{ github.repository }}/commits/$version) for detailed changes.
          "@
            
            $releaseNotes | Out-File -FilePath "release/RELEASE_NOTES.md" -Encoding utf8
            
            echo "Executable built: release/GitHubJiraSync-$version.exe"
          } else {
            Write-Error "No executable found in dist folder"
            exit 1
          }
        shell: pwsh
      
      - name: Create Git tag
        run: |
          $version = "${{ steps.calc_version.outputs.new_version }}"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a $version -m "Release $version"
          git push origin $version
        shell: pwsh
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.calc_version.outputs.new_version }}
          name: Release ${{ steps.calc_version.outputs.new_version }}
          body_path: release/RELEASE_NOTES.md
          draft: false
          prerelease: ${{ github.event.inputs.pre_release }}
          files: |
            release/*.exe
            FEEDBACK_TEST_REPORT.md
            IMPLEMENTATION_COMPLETE.md
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: GitHubJiraSync-${{ steps.calc_version.outputs.new_version }}
          path: |
            release/*.exe
            release/RELEASE_NOTES.md
