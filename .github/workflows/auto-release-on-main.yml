name: Auto Release on Main Push (DISABLED - Use Manual Release)

on:
  # DISABLED: Causing version conflicts. Use .github/workflows/manual-release.yml instead
  # push:
  #   branches:
  #     - main
  workflow_dispatch:  # Only allow manual triggers

permissions:
  contents: write

jobs:
  auto-release:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get latest tag and calculate next version
        id: version
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          
          # Parse version
          VERSION=${LATEST_TAG#v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          
          # Bump patch
          PATCH=$((PATCH + 1))
          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version_without_v=$MAJOR.$MINOR.$PATCH" >> $GITHUB_OUTPUT
          echo "New version will be: $NEW_VERSION"
      
      - name: Update app version
        run: |
          # Update the APP_VERSION constant in app.py
          sed -i "s/APP_VERSION = .*/APP_VERSION = \"${{ steps.version.outputs.version_without_v }}\"/" app.py
          echo "Updated APP_VERSION to ${{ steps.version.outputs.version_without_v }}"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add app.py
          git commit -m "chore: Update APP_VERSION to ${{ steps.version.outputs.new_version }}" || echo "No changes to commit"
      
      - name: Create release notes
        run: |
          mkdir -p release
          cat > release/RELEASE_NOTES.md << 'EOF'
          # Release ${{ steps.version.outputs.new_version }}
          
          ## What's New
          
          This release contains the latest changes merged to main.
          
          See the [commit history](https://github.com/${{ github.repository }}/compare/${{ steps.version.outputs.latest_tag }}...${{ github.sha }}) for detailed changes.
          
          ## Installation
          
          1. Download the executable from Assets below
          2. Run the .exe file
          3. Application will open at http://localhost:5000
          4. Configure your settings
          
          ## System Requirements
          
          - Windows 10/11
          - Chrome browser
          EOF
      
      - name: Create Git tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          # Push any version update commits
          git push origin HEAD:main || true
          git tag -a "${{ steps.version.outputs.new_version }}" -m "Release ${{ steps.version.outputs.new_version }}"
          git push origin "${{ steps.version.outputs.new_version }}"
      
      - name: Create Release (draft)
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.new_version }}
          name: Release ${{ steps.version.outputs.new_version }}
          body_path: release/RELEASE_NOTES.md
          draft: true
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  
  build-and-attach:
    needs: auto-release
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.auto-release.outputs.new_version }}
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install PyInstaller
        run: pip install pyinstaller
      
      - name: Install Python dependencies
        run: pip install -r requirements.txt
      
      - name: Package application
        run: |
          $iconPath = "assets/icon.ico"
          $cmd = "python -m PyInstaller --onefile --windowed --name=JiraAutomationAssistant"
          $cmd += " --add-data 'modern-ui.html;.'"
          $cmd += " --add-data 'assets;assets'"
          $cmd += " --add-data 'config.yaml;.'"
          
          if (Test-Path $iconPath) {
            $cmd += " --icon=$iconPath"
          }
          
          $cmd += " app.py"
          
          Write-Host "Running: $cmd"
          Invoke-Expression $cmd
          
          if (Test-Path "dist/JiraAutomationAssistant.exe") {
            New-Item -ItemType Directory -Path "release" -Force | Out-Null
            Copy-Item "dist/JiraAutomationAssistant.exe" "release/" -Force
            Write-Host "Executable packaged successfully"
          } else {
            Write-Host "ERROR: Failed to create executable"
            exit 1
          }
        shell: powershell
      
      - name: Create portable ZIP
        run: |
          if (Test-Path "dist") {
            Compress-Archive -Path "dist\*" -DestinationPath "release\Jira-Automation-Assistant-Portable.zip" -Force
            Write-Host "ZIP created successfully"
          } else {
            Write-Host "ERROR: No dist folder found"
            exit 1
          }
        shell: powershell
      
      - name: Prepare assets
        run: |
          if (Test-Path "release/JiraAutomationAssistant.exe") {
            Copy-Item "release/JiraAutomationAssistant.exe" "release/GitHubJiraSync.exe" -Force
            Write-Host "Assets prepared"
          } else {
            Write-Host "WARNING: Could not find executable to prepare"
          }
        shell: powershell
      
      - name: Upload assets to release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.auto-release.outputs.new_version }}
          files: |
            ./release/JiraAutomationAssistant.exe
            ./release/Jira-Automation-Assistant-Portable.zip
            ./release/GitHubJiraSync.exe
          draft: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
