name: Auto Release on Main Push (DISABLED - Use Manual Release)

on:
  # DISABLED: Causing version conflicts. Use .github/workflows/manual-release.yml instead
  # push:
  #   branches:
  #     - main
  workflow_dispatch:  # Only allow manual triggers

permissions:
  contents: write

jobs:
  auto-release:
    runs-on: ubuntu-latest
    outputs:
      new_version: ${{ steps.version.outputs.new_version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Get latest tag and calculate next version
        id: version
        run: |
          # Get the latest tag
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "latest_tag=$LATEST_TAG" >> $GITHUB_OUTPUT
          
          # Parse version
          VERSION=${LATEST_TAG#v}
          MAJOR=$(echo $VERSION | cut -d. -f1)
          MINOR=$(echo $VERSION | cut -d. -f2)
          PATCH=$(echo $VERSION | cut -d. -f3)
          
          # Bump patch
          PATCH=$((PATCH + 1))
          NEW_VERSION="v$MAJOR.$MINOR.$PATCH"
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "version_without_v=$MAJOR.$MINOR.$PATCH" >> $GITHUB_OUTPUT
          echo "New version will be: $NEW_VERSION"
      
      - name: Update app version
        run: |
          # Update the APP_VERSION constant in app.py
          sed -i "s/APP_VERSION = .*/APP_VERSION = \"${{ steps.version.outputs.version_without_v }}\"/" app.py
          echo "Updated APP_VERSION to ${{ steps.version.outputs.version_without_v }}"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add app.py
          git commit -m "chore: Update APP_VERSION to ${{ steps.version.outputs.new_version }}" || echo "No changes to commit"
      
      - name: Create Git tag
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          # Push any version update commits
          git push origin HEAD:main || true
          git tag -a "${{ steps.version.outputs.new_version }}" -m "Release ${{ steps.version.outputs.new_version }}"
          git push origin "${{ steps.version.outputs.new_version }}"

