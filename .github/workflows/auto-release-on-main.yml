name: Auto Release on Main Push

# Triggers when code is merged to main (via squash merge from PR)
on:
  push:
    branches:
      - main
    # Only trigger if these files change (ignore docs-only changes)
    paths-ignore:
      - '*.md'
      - '.gitignore'
      - 'DOCUMENTATION_*.md'

permissions:
  contents: write
  packages: write

jobs:
  auto-release:
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Check if we should create release
        id: should_release
        run: |
          # Get the latest tag
          $latestTag = git describe --tags --abbrev=0 2>$null
          if (-not $latestTag) { $latestTag = "v0.0.0" }
          
          # Get the last commit that created a tag (if any)
          $lastTagCommit = git rev-list -n 1 $latestTag 2>$null
          $currentCommit = git rev-parse HEAD
          
          # If current commit is different from last tag commit, we should release
          if ($lastTagCommit -ne $currentCommit) {
            echo "should_release=true" >> $env:GITHUB_OUTPUT
            echo "latest_tag=$latestTag" >> $env:GITHUB_OUTPUT
            echo "Commit is ahead of last tag, will create release"
          } else {
            echo "should_release=false" >> $env:GITHUB_OUTPUT
            echo "No new commits since last tag, skipping release"
          }
        shell: pwsh
      
      - name: Set up Python
        if: steps.should_release.outputs.should_release == 'true'
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install dependencies
        if: steps.should_release.outputs.should_release == 'true'
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install pyinstaller
      
      - name: Get latest tag
        if: steps.should_release.outputs.should_release == 'true'
        id: get_tag
        run: |
          $latestTag = git describe --tags --abbrev=0 2>$null
          if (-not $latestTag) { $latestTag = "v0.0.0" }
          echo "latest_tag=$latestTag" >> $env:GITHUB_OUTPUT
          echo "Latest tag: $latestTag"
        shell: pwsh
      
      - name: Calculate next version (patch bump)
        if: steps.should_release.outputs.should_release == 'true'
        id: calc_version
        run: |
          $latestTag = "${{ steps.get_tag.outputs.latest_tag }}"
          $version = $latestTag -replace '^v', ''
          $parts = $version -split '\.'
          $major = [int]$parts[0]
          $minor = [int]$parts[1]
          $patch = [int]$parts[2]
          
          # Auto patch bump on main push
          $patch++
          
          $newVersion = "v$major.$minor.$patch"
          echo "new_version=$newVersion" >> $env:GITHUB_OUTPUT
          echo "New version: $newVersion"
        shell: pwsh
      
      - name: Build executable with PyInstaller
        if: steps.should_release.outputs.should_release == 'true'
        run: |
          if (Test-Path "GitHubJiraSync.spec") {
            pyinstaller GitHubJiraSync.spec
          } elseif (Test-Path "JiraAutomationAssistant.spec") {
            pyinstaller JiraAutomationAssistant.spec
          } else {
            pyinstaller --name="GitHubJiraSync" --onefile --windowed --icon="assets/icon.ico" app.py
          }
        shell: pwsh
      
      - name: Prepare release assets
        if: steps.should_release.outputs.should_release == 'true'
        run: |
          $version = "${{ steps.calc_version.outputs.new_version }}"
          New-Item -ItemType Directory -Force -Path release
          
          # Find the built executable
          $exePath = Get-ChildItem -Path "dist" -Filter "*.exe" -Recurse | Select-Object -First 1
          
          if ($exePath) {
            $exeName = $exePath.Name
            Copy-Item $exePath.FullName -Destination "release/GitHubJiraSync-$version.exe"
            
            # Create release notes from latest commit message
            $latestCommit = git log -1 --format='%s%n%b'
            $releaseNotes = @"
# Release $version

## What's New in $version

$latestCommit

## Installation

1. Download ``GitHubJiraSync-$version.exe``
2. Run the executable
3. Browser will open to http://localhost:5000
4. Configure your settings and start using the app

## Requirements

- Windows 10/11
- Chrome browser (for Jira automation)

## Changes in this release

$latestCommit

---

*This release was automatically generated when code was merged to main.*
"@
            
            $releaseNotes | Out-File -FilePath "release/RELEASE_NOTES.md" -Encoding utf8
            
            echo "Executable built: release/GitHubJiraSync-$version.exe"
          } else {
            Write-Error "No executable found in dist folder"
            exit 1
          }
        shell: pwsh
      
      - name: Create and push tag
        if: steps.should_release.outputs.should_release == 'true'
        run: |
          $version = "${{ steps.calc_version.outputs.new_version }}"
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git tag -a $version -m "Release $version [auto-generated from main merge]"
          git push origin $version
          echo "Tag $version created and pushed"
        shell: pwsh
      
      - name: Create GitHub Release
        if: steps.should_release.outputs.should_release == 'true'
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.calc_version.outputs.new_version }}
          name: Release ${{ steps.calc_version.outputs.new_version }}
          body_path: release/RELEASE_NOTES.md
          draft: false
          prerelease: false
          files: |
            release/*.exe
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Upload build artifacts
        if: steps.should_release.outputs.should_release == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: GitHubJiraSync-${{ steps.calc_version.outputs.new_version }}
          path: |
            release/*.exe
            release/RELEASE_NOTES.md
          retention-days: 30
      
      - name: No release needed
        if: steps.should_release.outputs.should_release != 'true'
        run: echo "ℹ️ No release created (no new commits since last tag)"
        shell: pwsh
